<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAGS FEE TRACKER</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0b;
            color: #d4d4d8;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            margin-bottom: 24px;
            border-bottom: 1px solid #1a1a1c;
            padding-bottom: 16px;
        }
        h1 {
            color: #74d856;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .subtitle {
            color: #71717a;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Stats Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #0f0f10;
            border: 1px solid #1a1a1c;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }
        .stat-card:hover {
            border-color: #27272a;
            transform: translateY(-2px);
        }
        .stat-icon {
            font-size: 20px;
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 10px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            font-family: 'Monaco', monospace;
            margin-bottom: 4px;
        }
        .stat-value.green {
            color: #74d856;
        }
        .stat-value.yellow {
            color: #facc15;
        }
        .stat-subvalue {
            font-size: 11px;
            color: #71717a;
            font-family: 'Monaco', monospace;
        }
        .stat-progress {
            height: 4px;
            background: #1a1a1c;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .stat-progress-bar {
            height: 100%;
            background: #74d856;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Copy Button */
        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: transparent;
            border: 1px solid #1a1a1c;
            border-radius: 6px;
            color: #71717a;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .copy-btn:hover {
            border-color: #74d856;
            color: #74d856;
        }
        .copy-btn.copied {
            border-color: #74d856;
            color: #74d856;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-badge.active {
            background: rgba(116, 216, 86, 0.1);
            color: #74d856;
            border: 1px solid #74d856;
        }
        .status-badge.pending {
            background: rgba(250, 204, 21, 0.1);
            color: #facc15;
            border: 1px solid #facc15;
        }
        .status-badge.inactive {
            background: rgba(113, 113, 122, 0.1);
            color: #71717a;
            border: 1px solid #27272a;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: #1a1a1c;
            color: #d4d4d8;
            text-align: center;
            border-radius: 6px;
            padding: 6px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            white-space: nowrap;
            border: 1px solid #27272a;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Animations */
        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .slide-in {
            animation: slideInDown 0.3s ease-out;
        }
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Last Checked */
        .last-checked {
            font-size: 10px;
            color: #52525b;
            font-style: italic;
            margin-top: 8px;
        }

        /* Panel */
        .panel {
            background: #0f0f10;
            border: 1px solid #1a1a1c;
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 0;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #1a1a1c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 11px;
            font-weight: 600;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .panel-body {
            padding: 16px;
        }

        /* Search Section */
        .search-section {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #1a1a1c;
            border-radius: 8px;
            background: #0a0a0b;
            color: #d4d4d8;
            font-size: 13px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: 500;
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #74d856;
        }
        input::placeholder {
            color: #3f3f46;
            font-weight: 400;
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            border: 1px solid #1a1a1c;
            border-radius: 8px;
            background: #0a0a0b;
            color: #d4d4d8;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #74d856;
            color: #0a0a0b;
            border-color: #74d856;
        }
        .btn-primary:hover {
            background: #5fb841;
            border-color: #5fb841;
        }
        .btn-secondary {
            border-color: #1a1a1c;
        }
        .btn-secondary:hover {
            background: #1a1a1c;
            border-color: #27272a;
        }
        .btn-danger {
            background: transparent;
            color: #ef4444;
            border-color: #ef4444;
            padding: 8px 14px;
            font-size: 11px;
        }
        .btn-danger:hover {
            background: #ef4444;
            color: #0a0a0b;
        }
        .btn-expand {
            background: transparent;
            color: #74d856;
            border: 1px solid #74d856;
            padding: 6px 14px;
            font-size: 10px;
        }
        .btn-expand:hover {
            background: rgba(116, 216, 86, 0.1);
        }

        /* Messages */
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            color: #fca5a5;
            padding: 10px 14px;
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .success {
            background: rgba(116, 216, 86, 0.1);
            border: 1px solid #74d856;
            border-radius: 8px;
            color: #74d856;
            padding: 10px 14px;
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .data-table th {
            text-align: left;
            padding: 10px 12px;
            font-weight: 600;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 10px;
            border-bottom: 1px solid #1a1a1c;
        }
        .data-table td {
            padding: 12px 12px;
            border-bottom: 1px solid #1a1a1c;
            color: #d4d4d8;
            font-weight: 500;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover {
            background: #0a0a0b;
        }

        /* Profile Images */
        .profile-img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #1a1a1c;
            object-fit: cover;
            vertical-align: middle;
            margin-right: 8px;
        }

        /* Token Header */
        .token-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #0a0a0b;
            border: 1px solid #1a1a1c;
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .token-logo {
            width: 40px;
            height: 40px;
            background: #1a1a1c;
            border: 1px solid #27272a;
            border-radius: 8px;
            object-fit: cover;
        }
        .token-info { flex: 1; }
        .token-ticker {
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }
        .token-name {
            font-size: 11px;
            color: #71717a;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .token-address {
            font-size: 10px;
            color: #52525b;
            font-family: 'Monaco', monospace;
        }

        /* Compact Receiver Row */
        .receiver-row {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 16px;
            align-items: center;
            padding: 12px 16px;
            background: #0f0f10;
            border: 1px solid #1a1a1c;
            border-radius: 10px;
            margin-bottom: 8px;
        }
        .receiver-row:hover {
            background: #0a0a0b;
        }

        .receiver-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .receiver-profile-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #27272a;
            object-fit: cover;
        }
        .receiver-username {
            font-weight: 600;
            color: #d4d4d8;
            font-size: 13px;
        }
        .receiver-username a {
            color: #74d856;
            text-decoration: none;
        }
        .receiver-username a:hover {
            text-decoration: underline;
        }
        .receiver-wallet {
            font-family: 'Monaco', monospace;
            font-size: 10px;
            color: #52525b;
        }

        .receiver-stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        .receiver-stat {
            text-align: center;
        }
        .receiver-stat-label {
            font-size: 9px;
            color: #52525b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .receiver-stat-value {
            font-size: 14px;
            font-weight: 700;
            font-family: 'Monaco', monospace;
            color: #d4d4d8;
        }
        .receiver-stat-value.claimed {
            color: #74d856;
        }
        .receiver-stat-value.unclaimed {
            color: #facc15;
        }

        .fee-badge {
            background: transparent;
            color: #74d856;
            padding: 4px 10px;
            border: 1px solid #74d856;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 700;
            font-family: 'Monaco', monospace;
        }

        /* Claims Expandable Section */
        .claims-expandable {
            display: none;
            border-top: 1px solid #1a1a1c;
            padding: 16px;
            background: #0a0a0b;
        }
        .claims-expandable.expanded {
            display: block;
        }

        .claim-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 16px;
            padding: 10px 12px;
            border-bottom: 1px solid #1a1a1c;
            align-items: center;
        }
        .claim-row:last-child {
            border-bottom: none;
        }
        .claim-row:hover {
            background: #0f0f10;
        }
        .claim-amount {
            font-size: 13px;
            font-weight: 700;
            color: #74d856;
            font-family: 'Monaco', monospace;
        }
        .claim-date {
            font-size: 11px;
            color: #71717a;
            font-family: 'Monaco', monospace;
        }
        .claim-link {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid #1a1a1c;
            border-radius: 6px;
            color: #71717a;
            text-decoration: none;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .claim-link:hover {
            border-color: #74d856;
            color: #74d856;
        }

        /* Info Notice */
        .info-notice {
            background: transparent;
            border: 1px solid #1a1a1c;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 12px;
            font-size: 10px;
            color: #71717a;
            font-weight: 500;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #52525b;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Utility Classes */
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BAGS FEE TRACKER</h1>
            <p class="subtitle">Real-time fee receiver monitoring</p>
        </div>

        <!-- Stats Dashboard -->
        <div id="statsDashboard" style="display:none;" class="stats-dashboard">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-label">Total Claimed</div>
                <div class="stat-value green" id="totalClaimed">0.00</div>
                <div class="stat-subvalue" id="totalClaimedCount">0 claims</div>
                <div class="stat-progress">
                    <div class="stat-progress-bar" id="claimedProgress" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-label">Total Unclaimed</div>
                <div class="stat-value yellow" id="totalUnclaimed">0.00</div>
                <div class="stat-subvalue" id="unclaimedPercent">0% of total</div>
                <div class="stat-progress">
                    <div class="stat-progress-bar" id="unclaimedProgress" style="width: 0%; background: #facc15;"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-label">Tracking</div>
                <div class="stat-value" id="trackingCount">0</div>
                <div class="stat-subvalue"><span id="tokenCount">0</span> tokens ‚Ä¢ <span id="walletCount">0</span> wallets</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">Token Search</span>
            </div>
            <div class="panel-body">
                <div class="search-section">
                    <input
                        type="text"
                        id="tokenMint"
                        placeholder="ENTER TOKEN MINT ADDRESS"
                    />
                    <button class="btn-primary" onclick="findReceivers()">FIND RECEIVERS</button>
                </div>

                <div id="error" style="display:none;"></div>
                <div id="loading" style="display:none;" class="success">LOADING...</div>
                <div id="results"></div>
            </div>
        </div>

        <div id="tracked" style="display:none;" class="panel">
            <div class="panel-header">
                <span class="panel-title">Tracked Receivers</span>
                <button class="btn-secondary" onclick="checkAllClaims()">CHECK ALL</button>
            </div>
            <div class="panel-body" style="padding: 0;">
                <div id="trackedList"></div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = window.location.hostname === 'localhost' ? 'http://localhost:3001' : '';
        let trackedTokens = JSON.parse(localStorage.getItem('trackedTokens') || '[]');

        window.addEventListener('load', () => {
            // Check if opened as file:// protocol
            if (window.location.protocol === 'file:') {
                showError('Please open this file through a web server (localhost), not as a file. The API calls will not work from file://');
                return;
            }
            updateTrackedList();
        });

        async function findReceivers() {
            const tokenMint = document.getElementById('tokenMint').value.trim();

            if (!tokenMint) {
                showError('Please enter a token mint address');
                return;
            }

            hideError();
            showLoading();
            document.getElementById('results').innerHTML = '';

            try {
                const response = await fetch(`${BACKEND_URL}/api/token/${tokenMint}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch token data');
                }

                if (!data.response || !data.response.creators || data.response.creators.length === 0) {
                    throw new Error('No creator data found for this token');
                }

                const creators = data.response.creators;
                let html = '<div style="margin-top: 16px;"><table class="data-table"><thead><tr><th>RECEIVER</th><th>WALLET</th><th>FEE SPLIT</th><th></th></tr></thead><tbody>';
                let foundAny = false;

                for (const creator of creators) {
                    const twitterUsername = creator.twitterUsername || creator.providerUsername || creator.socialAccount?.username;
                    const wallet = creator.wallet;
                    const feePercentage = creator.royaltyBps ? (creator.royaltyBps / 100) : 0;
                    const pfp = creator.pfp || '';

                    if (twitterUsername && wallet) {
                        foundAny = true;
                        html += `
                            <tr>
                                <td>
                                    ${pfp ? `<img src="${pfp}" class="profile-img" onerror="this.style.display='none'">` : ''}
                                    <strong><a href="https://x.com/${twitterUsername}" target="_blank" style="color: #74d856; text-decoration: none;">@${twitterUsername}</a></strong>
                                </td>
                                <td style="font-family: Monaco, monospace; font-size: 11px; color: #71717a;">${wallet}</td>
                                <td><span class="fee-badge">${feePercentage}%</span></td>
                                <td style="text-align: right;">
                                    <button class="btn-primary" onclick="trackCreator('${tokenMint}', '${twitterUsername}', '${wallet}', ${feePercentage}, '${pfp.replace(/'/g, "\\'")}')">
                                        TRACK
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                }

                html += '</tbody></table>';

                if (!foundAny) {
                    html = `<div class="empty-state" style="padding: 60px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                        <div style="font-size: 14px; color: #d4d4d8; margin-bottom: 8px; text-transform: none;">No Fee Receivers Found</div>
                        <div style="font-size: 11px; color: #71717a; text-transform: none; letter-spacing: normal; font-weight: 400;">
                            This token doesn't have any fee receivers configured
                        </div>
                    </div>`;
                }

                html += '</div>';
                document.getElementById('results').innerHTML = html;

            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        }

        async function trackCreator(tokenMint, username, wallet, feePercentage, pfp) {
            const existing = trackedTokens.find(t =>
                t.wallet === wallet && t.tokenMint === tokenMint
            );

            if (existing) {
                showError(`Already tracking @${username} for this token`);
                return;
            }

            // Fetch token metadata
            let tokenMetadata = null;
            try {
                const metaResponse = await fetch(`${BACKEND_URL}/api/token-info/${tokenMint}`);
                tokenMetadata = await metaResponse.json();
            } catch (err) {
                console.log('Could not fetch token metadata:', err);
            }

            const token = {
                id: Date.now(),
                tokenMint,
                username,
                wallet,
                feePercentage,
                pfp: pfp || '',
                hasClaimed: false,
                claimHistory: [],
                totalClaimed: 0,
                claimCount: 0,
                addedAt: new Date().toISOString(),
                lastChecked: null,
                tokenMetadata: tokenMetadata
            };

            trackedTokens.push(token);
            saveTrackedTokens();
            updateTrackedList();
            showSuccess(`Now tracking @${username}`);

            setTimeout(() => checkClaim(token.id), 1000);
        }

        async function checkClaim(tokenId) {
            const token = trackedTokens.find(t => t.id === tokenId);
            if (!token) return;

            try {
                showLoading();

                // Fetch claim history
                const claimResponse = await fetch(
                    `${BACKEND_URL}/api/check-claim/${token.wallet}/${token.tokenMint}`
                );
                const claimData = await claimResponse.json();

                token.hasClaimed = claimData.hasClaimed;
                token.claimHistory = claimData.claimHistory || [];
                token.totalClaimed = claimData.totalClaimed || 0;
                token.claimCount = claimData.claimCount || 0;
                token.lastChecked = claimData.lastChecked;
                token.currency = claimData.currency || 'SOL';

                // Fetch lifetime fees
                try {
                    const lifetimeResponse = await fetch(
                        `${BACKEND_URL}/api/lifetime-fees/${token.tokenMint}`
                    );
                    const lifetimeData = await lifetimeResponse.json();
                    token.lifetimeFees = lifetimeData;
                } catch (err) {
                    console.log('Could not fetch lifetime fees:', err);
                    token.lifetimeFees = null;
                }

                saveTrackedTokens();
                updateTrackedList();
                hideLoading();

                if (claimData.hasClaimed) {
                    showSuccess(`Found ${claimData.claimCount} claim(s) for @${token.username}`);
                }
            } catch (err) {
                console.error('Failed to check claim:', err);
                showError('Failed to check claim: ' + err.message);
                hideLoading();
            }
        }

        async function checkAllClaims() {
            for (const token of trackedTokens) {
                await checkClaim(token.id);
            }
        }

        function toggleClaims(tokenId) {
            const element = document.getElementById('claims-' + tokenId);
            if (element) {
                element.classList.toggle('expanded');
                const btn = document.getElementById('btn-' + tokenId);
                if (btn) {
                    btn.textContent = element.classList.contains('expanded') ? 'COLLAPSE' : 'VIEW CLAIMS';
                }
            }
        }

        // Copy to clipboard function
        function copyToClipboard(text, buttonId) {
            navigator.clipboard.writeText(text).then(() => {
                // Show success message
                showSuccess('Copied to clipboard');

                // Also update button if it exists (for backwards compatibility)
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('copied');
                    btn.innerHTML = '‚úì COPIED';
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.innerHTML = 'üìã COPY';
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
                showError('Failed to copy to clipboard');
            });
        }

        // Update stats dashboard
        function updateStats() {
            let totalClaimed = 0;
            let totalUnclaimed = 0;
            let totalClaimCount = 0;
            const uniqueTokens = new Set();
            const uniqueWallets = new Set();

            trackedTokens.forEach(token => {
                uniqueTokens.add(token.tokenMint);
                uniqueWallets.add(token.wallet);

                // Add claimed
                totalClaimed += token.totalClaimed || 0;
                totalClaimCount += token.claimCount || 0;

                // Calculate unclaimed
                if (token.lifetimeFees && token.lifetimeFees.success && token.lifetimeFees.response) {
                    const totalFeesLamports = typeof token.lifetimeFees.response === 'string'
                        ? parseFloat(token.lifetimeFees.response)
                        : token.lifetimeFees.response;
                    const totalFeesSol = totalFeesLamports / 1e9;
                    const userShareSol = (totalFeesSol * token.feePercentage) / 100;
                    const userClaimedSol = token.totalClaimed || 0;
                    const unclaimed = Math.max(0, userShareSol - userClaimedSol);
                    totalUnclaimed += unclaimed;
                }
            });

            const grandTotal = totalClaimed + totalUnclaimed;
            const claimedPercent = grandTotal > 0 ? (totalClaimed / grandTotal * 100) : 0;
            const unclaimedPercent = grandTotal > 0 ? (totalUnclaimed / grandTotal * 100) : 0;

            // Update dashboard
            document.getElementById('statsDashboard').style.display = 'grid';
            document.getElementById('totalClaimed').textContent = totalClaimed.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4}) + ' SOL';
            document.getElementById('totalClaimedCount').textContent = totalClaimCount + ' claims';
            document.getElementById('claimedProgress').style.width = claimedPercent + '%';

            document.getElementById('totalUnclaimed').textContent = totalUnclaimed.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4}) + ' SOL';
            document.getElementById('unclaimedPercent').textContent = unclaimedPercent.toFixed(0) + '% of total';
            document.getElementById('unclaimedProgress').style.width = unclaimedPercent + '%';

            document.getElementById('trackingCount').textContent = trackedTokens.length;
            document.getElementById('tokenCount').textContent = uniqueTokens.size;
            document.getElementById('walletCount').textContent = uniqueWallets.size;
        }

        function updateTrackedList() {
            const trackedDiv = document.getElementById('tracked');
            const listDiv = document.getElementById('trackedList');

            if (trackedTokens.length === 0) {
                trackedDiv.style.display = 'none';
                document.getElementById('statsDashboard').style.display = 'none';
                return;
            }

            trackedDiv.style.display = 'block';
            updateStats();

            // Group by token
            const groupedByToken = {};
            trackedTokens.forEach(token => {
                if (!groupedByToken[token.tokenMint]) {
                    groupedByToken[token.tokenMint] = [];
                }
                groupedByToken[token.tokenMint].push(token);
            });

            let html = '';

            for (const [tokenMint, tokens] of Object.entries(groupedByToken)) {
                const tokenMeta = tokens[0].tokenMetadata || {};
                const tokenImage = tokenMeta.logoURI || '';
                const tokenName = tokenMeta.name || 'Unknown Token';
                const tokenSymbol = tokenMeta.symbol || tokenMint.slice(0, 8);

                // Determine token status
                const hasUnclaimed = tokens.some(t => {
                    if (t.lifetimeFees && t.lifetimeFees.success && t.lifetimeFees.response) {
                        const totalFeesLamports = typeof t.lifetimeFees.response === 'string' ? parseFloat(t.lifetimeFees.response) : t.lifetimeFees.response;
                        const totalFeesSol = totalFeesLamports / 1e9;
                        const userShareSol = (totalFeesSol * t.feePercentage) / 100;
                        const unclaimed = Math.max(0, userShareSol - (t.totalClaimed || 0));
                        return unclaimed > 0.01;
                    }
                    return false;
                });
                const statusClass = hasUnclaimed ? 'active' : 'inactive';
                const statusText = hasUnclaimed ? 'Active' : 'No Activity';
                const copyBtnId = 'copy-mint-' + tokenMint.slice(0, 8);

                // Token Header
                html += `
                    <div class="token-header">
                        ${tokenImage ? `<img src="${tokenImage}" class="token-logo" onerror="this.style.display='none'">` : '<div class="token-logo"></div>'}
                        <div class="token-info">
                            <div class="token-ticker">${tokenSymbol}</div>
                            <div class="token-name">${tokenName}</div>
                            <div class="token-address">
                                <span onclick="copyToClipboard('${tokenMint}', '${copyBtnId}')" style="cursor: pointer;" title="Click to copy">
                                    ${tokenMint.slice(0, 12)}...${tokenMint.slice(-12)}
                                </span>
                                <button class="copy-btn" id="${copyBtnId}" onclick="copyToClipboard('${tokenMint}', '${copyBtnId}')" style="display: none;">üìã COPY</button>
                                <a href="https://solscan.io/token/${tokenMint}" target="_blank" style="margin-left: 6px; color: #71717a; text-decoration: none; font-size: 11px;" title="View on Solscan">üîó</a>
                            </div>
                        </div>
                        <span class="status-badge ${statusClass}">
                            <span class="status-dot"></span>
                            ${statusText}
                        </span>
                    </div>
                `;

                // Each tracked receiver - COMPACT ROW
                tokens.forEach(token => {
                    // Calculate unclaimed
                    let unclaimedSol = 0;
                    if (token.lifetimeFees && token.lifetimeFees.success && token.lifetimeFees.response) {
                        const totalFeesLamports = typeof token.lifetimeFees.response === 'string'
                            ? parseFloat(token.lifetimeFees.response)
                            : token.lifetimeFees.response;
                        const totalFeesSol = totalFeesLamports / 1e9;
                        const userShareSol = (totalFeesSol * token.feePercentage) / 100;
                        const userClaimedSol = token.totalClaimed || 0;
                        unclaimedSol = Math.max(0, userShareSol - userClaimedSol);
                    }

                    // Receiver status
                    const receiverStatus = unclaimedSol > 0.01 ? 'active' : 'inactive';
                    const receiverStatusText = unclaimedSol > 0.01 ? 'Has Unclaimed' : 'Up to date';
                    const walletCopyId = 'copy-wallet-' + token.id;

                    // Last checked time
                    let lastCheckedText = '';
                    if (token.lastChecked) {
                        const lastChecked = new Date(token.lastChecked);
                        const now = new Date();
                        const diffMs = now - lastChecked;
                        const diffMins = Math.floor(diffMs / 60000);
                        if (diffMins < 1) lastCheckedText = 'Just now';
                        else if (diffMins < 60) lastCheckedText = `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
                        else if (diffMins < 1440) lastCheckedText = `${Math.floor(diffMins / 60)} hour${Math.floor(diffMins / 60) > 1 ? 's' : ''} ago`;
                        else lastCheckedText = `${Math.floor(diffMins / 1440)} day${Math.floor(diffMins / 1440) > 1 ? 's' : ''} ago`;
                    }

                    html += `
                        <div class="receiver-row">
                            <div class="receiver-profile">
                                ${token.pfp ? `<img src="${token.pfp}" class="receiver-profile-img" onerror="this.style.display='none'">` : ''}
                                <div>
                                    <div class="receiver-username">
                                        <a href="https://x.com/${token.username}" target="_blank">@${token.username}</a>
                                        <span class="status-badge ${receiverStatus}" style="margin-left: 8px; font-size: 9px; padding: 2px 6px;">
                                            <span class="status-dot"></span>
                                            ${receiverStatusText}
                                        </span>
                                    </div>
                                    <div class="receiver-wallet">
                                        <span onclick="copyToClipboard('${token.wallet}', '${walletCopyId}')" style="cursor: pointer;" title="Click to copy">
                                            ${token.wallet.slice(0, 12)}...${token.wallet.slice(-8)}
                                        </span>
                                        <button class="copy-btn" id="${walletCopyId}" onclick="copyToClipboard('${token.wallet}', '${walletCopyId}')" style="margin-left: 6px; padding: 2px 6px; font-size: 9px; display: none;">üìã</button>
                                        <a href="https://solscan.io/account/${token.wallet}" target="_blank" style="margin-left: 6px; color: #71717a; text-decoration: none; font-size: 11px;" title="View on Solscan">üîó</a>
                                    </div>
                                </div>
                            </div>

                            <div class="receiver-stats">
                                <div class="receiver-stat tooltip">
                                    <div class="receiver-stat-label">Fee Split</div>
                                    <div class="receiver-stat-value">${token.feePercentage}%</div>
                                    <span class="tooltiptext">Percentage of fees allocated to this wallet</span>
                                </div>
                                <div class="receiver-stat tooltip">
                                    <div class="receiver-stat-label">Claimed</div>
                                    <div class="receiver-stat-value claimed">${(token.totalClaimed || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4})}</div>
                                    <span class="tooltiptext">Total SOL claimed from fees</span>
                                </div>
                                <div class="receiver-stat tooltip">
                                    <div class="receiver-stat-label">Unclaimed</div>
                                    <div class="receiver-stat-value unclaimed">${unclaimedSol.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4})}</div>
                                    <span class="tooltiptext">Available SOL to claim</span>
                                </div>
                                <div class="receiver-stat">
                                    <div class="receiver-stat-label">Claims</div>
                                    <div class="receiver-stat-value">${token.claimCount || 0}</div>
                                </div>
                            </div>

                            <div>
                                ${token.claimHistory && token.claimHistory.length > 0 ? `<button class="btn-expand" id="btn-${token.id}" onclick="toggleClaims(${token.id})">VIEW CLAIMS</button>` : '<span style="color: #52525b; font-size: 11px;">NO CLAIMS</span>'}
                                ${lastCheckedText ? `<div class="last-checked">Last checked: ${lastCheckedText}</div>` : ''}
                            </div>

                            <button class="btn-secondary" onclick="checkClaim(${token.id})">CHECK</button>
                            <button class="btn-danger" onclick="removeToken(${token.id})">REMOVE</button>
                        </div>

                        ${token.claimHistory && token.claimHistory.length > 0 ? `
                        <div class="receiver-row" style="padding: 0; background: #0a0a0b; border-top: none;">
                            <div class="claims-expandable" id="claims-${token.id}">
                    ` : ''}
                    `;

                    // Claims History
                    if (token.claimHistory && token.claimHistory.length > 0) {
                        token.claimHistory.forEach(claim => {
                            // Handle both seconds and milliseconds timestamps
                            const timestamp = claim.timestamp > 10000000000 ? claim.timestamp : claim.timestamp * 1000;
                            const date = new Date(timestamp);
                            const dateStr = date.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
                            const timeStr = date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});

                            html += `
                                <div class="claim-row">
                                    <div class="claim-amount">${claim.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4})} ${claim.currency}</div>
                                    <div class="claim-date">${dateStr} ${timeStr}</div>
                                    <a href="https://solscan.io/tx/${claim.signature}" target="_blank" class="claim-link">VIEW TX</a>
                                </div>
                            `;
                        });

                        html += `
                                <div class="info-notice">Showing claims from last 50 transactions</div>
                            </div>
                        </div>
                        `;
                    }
                });
            }

            listDiv.innerHTML = html;
        }

        function removeToken(tokenId) {
            if (confirm('Remove this tracked receiver?')) {
                trackedTokens = trackedTokens.filter(t => t.id !== tokenId);
                saveTrackedTokens();
                updateTrackedList();
                showSuccess('Receiver removed');
            }
        }

        function saveTrackedTokens() {
            localStorage.setItem('trackedTokens', JSON.stringify(trackedTokens));
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message.toUpperCase();
            errorDiv.className = 'error';
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message.toUpperCase();
            errorDiv.className = 'success slide-in';
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.classList.add('fade-out');
                setTimeout(hideError, 300);
            }, 2700);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
